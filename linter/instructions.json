{
  "emit": {
    "type": "object",
    "required": [
      "emit"
    ],
    "maxProperties": 1,
    "properties": {
      "emit": {
        "type": "object",
        "required": [
          "event"
        ],
        "properties": {
          "event": {
            "type": "string",
            "example": "prismeaiMessenger.message"
          },
          "payload": {},
          "target": {
            "type": "object",
            "properties": {
              "userTopic": {
                "type": "string"
              },
              "userId": {
                "type": "string"
              },
              "sessionId": {
                "type": "string"
              },
              "currentSocket": {
                "type": "boolean",
                "default": true,
                "description": "If emitted in response to an active socket (i.e source.socketId is set), this event is only visible to this same socket. Defaults to true"
              }
            }
          },
          "private": {
            "type": "boolean"
          },
          "autocomplete": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "from": {
                  "type": "string"
                },
                "path": {
                  "type": "string"
                },
                "template": {
                  "type": "string"
                }
              }
            }
          },
          "options": {
            "type": "object",
            "properties": {
              "persist": {
                "type": "boolean",
                "description": "Whether to persist this event or not. Defaults to true",
                "default": true
              },
              "aggPayload": {
                "type": "boolean",
                "default": false,
                "description": "Populate advanced aggregation payload for custom mappings & analytics. This is automatically enabled for events mapped in config.events.types.*"
              },
              "async": {
                "type": "boolean",
                "default": false,
                "description": "If true, the instruction will return control without waiting for the event to be emitted. Defaults to false"
              }
            }
          }
        }
      }
    }
  },
  "wait": {
    "type": "object",
    "required": [
      "wait"
    ],
    "maxProperties": 1,
    "properties": {
      "wait": {
        "type": "object",
        "required": [
          "oneOf"
        ],
        "properties": {
          "oneOf": {
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "event"
              ],
              "properties": {
                "event": {
                  "type": "string",
                  "example": "prismeaiMessenger.message"
                },
                "filters": {
                  "type": "object",
                  "description": "Only match the next event fulfilling these filters. Multiple filters will be joined with an 'AND' operator ",
                  "additionalProperties": {
                    "type": "string"
                  },
                  "example": {
                    "automationSlug": "someId",
                    "someObjectField.someNestedField": "foo"
                  }
                },
                "cancelTriggers": {
                  "type": "boolean",
                  "description": "If true, do not send this event to the the usual triggers"
                }
              }
            }
          },
          "timeout": {
            "type": "number",
            "description": "After N seconds, timeout & outputs an empty result. Defaults to 20"
          },
          "output": {
            "type": "string",
            "description": "Will save the caught event inside this variable",
            "example": "nameOfResultVariable"
          }
        }
      }
    }
  },
  "set": {
    "type": "object",
    "required": [
      "set"
    ],
    "maxProperties": 1,
    "properties": {
      "set": {
        "type": "object",
        "required": [
          "name",
          "value"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Variable name, might be \"foo\", \"session.sessionScopedFoo\", \"global.globalScopedFoo\", \"user.userScopedFoo\", ..."
          },
          "interface": {
            "type": "string",
            "description": "The ID of the schema form representing the structure of the value"
          },
          "value": {
            "description": "variable value"
          },
          "clone": {
            "type": "boolean",
            "description": "If true, will clone the provided object variable instead of a reference"
          },
          "type": {
            "type": "string",
            "enum": [
              "replace",
              "merge",
              "push"
            ],
            "description": "Choose merge in order to merge target variable with value. Value takes precedence."
          }
        }
      }
    }
  },
  "delete": {
    "type": "object",
    "required": [
      "delete"
    ],
    "maxProperties": 1,
    "properties": {
      "delete": {
        "type": "object",
        "required": [
          "name"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Variable name to remove"
          }
        }
      }
    }
  },
  "conditions": {
    "type": "object",
    "properties": {
      "default": {
        "type": "array"
      }
    },
    "additionalProperties": {
      "type": "array"
    },
    "minProperties": 1
  },
  "repeat": {
    "type": "object",
    "required": [
      "repeat"
    ],
    "maxProperties": 1,
    "properties": {
      "repeat": {
        "type": "object",
        "oneOf": [
          {
            "required": [
              "on",
              "do"
            ],
            "properties": {
              "on": {
                "type": "string"
              },
              "do": {
                "type": "array",
                "hidden": true
              },
              "until": {
                "type": "number"
              },
              "batch": {
                "type": "object",
                "title": "Async",
                "description": "Allows parallel execution in batches",
                "properties": {
                  "size": {
                    "type": "number",
                    "title": "Batch size",
                    "description": "Number of iterations executed at the same time. Each batch is only started after all iterations from previous batch are done"
                  },
                  "interval": {
                    "type": "number",
                    "title": "Interval",
                    "description": "Wait interval in ms between each batch"
                  }
                }
              }
            }
          },
          {
            "required": [
              "until",
              "do"
            ],
            "properties": {
              "until": {
                "type": "number"
              },
              "do": {
                "type": "array",
                "hidden": true
              },
              "batch": {
                "type": "object",
                "title": "Async",
                "description": "Allows parallel execution in batches",
                "properties": {
                  "size": {
                    "type": "number",
                    "title": "Batch size",
                    "description": "Number of iterations executed at the same time. Each batch is only started after all iterations from previous batch are done"
                  },
                  "interval": {
                    "type": "number",
                    "title": "Interval",
                    "description": "Wait interval in ms between each batch"
                  }
                }
              }
            }
          }
        ],
        "description": "One of \"on\" or \"until\" is required"
      }
    }
  },
  "all": {
    "type": "object",
    "required": [
      "all"
    ],
    "maxProperties": 1,
    "properties": {
      "all": {
        "description": "Execute each instruction in parallel. Pause current automation execution until all instructions are processed.",
        "type": "array",
        "items": {
          "type": "object"
        }
      }
    }
  },
  "break": {
    "type": "object",
    "required": [
      "break"
    ],
    "maxProperties": 1,
    "properties": {
      "break": {
        "description": "Stop current automation execution. Have one option that allow a break to break all parent automations.",
        "type": "object",
        "properties": {
          "scope": {
            "type": "string",
            "enum": [
              "all",
              "automation",
              "repeat"
            ],
            "description": "The scope argument defines in which scope the break will take effect. It only breaks the current automation by default, it can also break all parent automations. More options might become available in the future."
          },
          "payload": {
            "type": "object",
            "additionalProperties": true,
            "description": "An optional payload"
          }
        }
      }
    }
  },
  "fetch": {
    "type": "object",
    "required": [
      "fetch"
    ],
    "maxProperties": 1,
    "properties": {
      "fetch": {
        "description": "Send an HTTP request",
        "type": "object",
        "required": [
          "url"
        ],
        "properties": {
          "url": {
            "type": "string"
          },
          "method": {
            "type": "string",
            "enum": [
              "get",
              "post",
              "put",
              "patch",
              "delete",
              "GET",
              "POST",
              "PUT",
              "PATCH",
              "DELETE"
            ]
          },
          "headers": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            }
          },
          "prismeaiApiKey": {
            "type": "object",
            "description": "Only for requests towards prisme.ai API. Grants additional permissions using api keys",
            "properties": {
              "name": {
                "type": "string",
                "description": "Use one of the DSUL Security defined api keys, referred by its name."
              }
            }
          },
          "query": {
            "type": "object",
            "description": "Object defining querystring parameters",
            "additionalProperties": {
              "type": "string"
            }
          },
          "body": {
            "description": "HTTP request body"
          },
          "emitErrors": {
            "description": "If HTTP response status code is 4xx or 5xx, emits a runtime.fetch.failed event by default",
            "type": "boolean",
            "default": true
          },
          "multipart": {
            "description": "Sends a multipart/form-data HTTP request",
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "fieldname",
                "value"
              ],
              "properties": {
                "fieldname": {
                  "type": "string"
                },
                "value": {
                  "type": "string",
                  "description": "Must be a string. Raw files must be given as base64"
                },
                "filename": {
                  "type": "string",
                  "description": "Filename is required when value is a base64 encoded file"
                },
                "contentType": {
                  "type": "string",
                  "description": "Optional MIME content-type"
                }
              }
            }
          },
          "allowSelfSignedCert": {
            "description": "Allow self signed https certificates",
            "type": "boolean"
          },
          "output": {
            "type": "string",
            "description": "Name of the variable which will hold the result"
          },
          "stream": {
            "type": "object",
            "description": "By default, SSE chunks are written to the output variable which can be read in real time using repeat instruction. Change this behaviour to emit chunks as individual events instead.",
            "required": [
              "event"
            ],
            "properties": {
              "event": {
                "type": "string"
              },
              "endChunk": {
                "description": "Allows to configure a custom ending chunk"
              },
              "concatenate": {
                "type": "object",
                "properties": {
                  "path": {
                    "type": "string"
                  },
                  "throttle": {
                    "type": "number"
                  }
                }
              },
              "payload": {
                "type": "object",
                "additionalProperties": true
              },
              "target": {
                "type": "object",
                "properties": {
                  "userTopic": {
                    "type": "string"
                  },
                  "userId": {
                    "type": "string"
                  },
                  "sessionId": {
                    "type": "string"
                  },
                  "currentSocket": {
                    "type": "boolean",
                    "default": true,
                    "description": "If emitted in response to an active socket (i.e source.socketId is set), this event is only visible to this same socket. Defaults to true"
                  }
                }
              },
              "options": {
                "type": "object",
                "properties": {
                  "persist": {
                    "type": "boolean",
                    "description": "Whether to persist this event or not. Defaults to true",
                    "default": true
                  },
                  "aggPayload": {
                    "type": "boolean",
                    "default": false,
                    "description": "Populate advanced aggregation payload for custom mappings & analytics. This is automatically enabled for events mapped in config.events.types.*"
                  },
                  "async": {
                    "type": "boolean",
                    "default": false,
                    "description": "If true, the instruction will return control without waiting for the event to be emitted. Defaults to false"
                  }
                }
              }
            }
          },
          "outputMode": {
            "type": "string",
            "default": "body",
            "enum": [
              "body",
              "detailed_response",
              "data_url",
              "base64"
            ]
          },
          "auth": {
            "type": "object",
            "title": "Authentication",
            "properties": {
              "prismeai": {
                "type": "object",
                "title": "Prisme.ai",
                "properties": {
                  "forwardWorkspaceAuth": {
                    "type": "boolean",
                    "description": "Enable in order to forward previously authenticated workspace in this fetch"
                  }
                }
              },
              "awsv4": {
                "type": "object",
                "additionalProperties": true,
                "title": "AWS Signature V4",
                "properties": {
                  "accessKeyId": {
                    "type": "string",
                    "title": "Access Key ID"
                  },
                  "secretAccessKey": {
                    "type": "string",
                    "title": "Secret Access Key"
                  },
                  "service": {
                    "type": "string"
                  },
                  "region": {
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "comment": {
    "type": "object",
    "required": [
      "comment"
    ],
    "maxProperties": 1,
    "properties": {
      "comment": {
        "description": "Do nothing but display a comment in instructions list",
        "type": "string"
      }
    }
  },
  "ratelimit": {
    "type": "object",
    "required": [
      "rateLimit"
    ],
    "maxProperties": 1,
    "properties": {
      "rateLimit": {
        "type": "object",
        "required": [
          "name",
          "consumer",
          "window",
          "limit"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Name your rate limit",
            "example": "ApiCall"
          },
          "consumer": {
            "description": "Consumer identifying key like user id, ip, ... ",
            "type": "string"
          },
          "window": {
            "type": "number",
            "description": "Fixed time window length in seconds."
          },
          "limit": {
            "type": "number",
            "description": "Maximum number of points which can be consumed over the given window"
          },
          "consume": {
            "type": "number",
            "description": "Number of points consumed for 1 rateLimit call, defaults to 1"
          },
          "break": {
            "type": "boolean",
            "description": "Set to false in order to return reached limit error instead of breaking current automation"
          },
          "output": {
            "type": "string",
            "description": "Will save the caught event inside this variable",
            "example": "nameOfResultVariable"
          }
        }
      }
    }
  },
  "run": {
    "type": "object",
    "required": [
      "run"
    ],
    "maxProperties": 1,
    "properties": {
      "run": {
        "type": "object",
        "description": "Generic run instruction to execute various function modules",
        "required": [
          "module",
          "function"
        ],
        "properties": {
          "module": {
            "type": "string"
          },
          "function": {
            "type": "string"
          },
          "parameters": {},
          "onError": {
            "type": "string",
            "default": "break",
            "enum": [
              "break",
              "emit",
              "continue"
            ]
          }
        }
      }
    }
  }
}